"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[517],{906:(e,o,r)=>{r.d(o,{KA:()=>n,OW:()=>s,YG:()=>i,cI:()=>c,dD:()=>t,tv:()=>l,y1:()=>d});var a=r(3217);async function t(e){try{let{data:{user:o},error:r}=await a.ND.auth.getUser();if(r||!o)return null;let{data:t,error:n}=await a.ND.from("user_api_keys").select("*").eq("user_id",o.id).eq("provider",e).eq("is_active",!0).maybeSingle();if(n)return"PGRST116"!==n.code&&console.warn("Erro ao buscar API Key do usu\xe1rio:",n.message),null;if(!t)return null;return t.api_key||null}catch(e){return console.warn("Erro ao buscar API Key do usu\xe1rio (ignorado):",(null==e?void 0:e.message)||e),null}}async function n(e,o){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];try{let t,{data:{user:n}}=await a.ND.auth.getUser();if(!n)throw Error("Usu\xe1rio n\xe3o autenticado");if(!o||o.trim().length<10)throw Error("API Key inv\xe1lida");let{data:s}=await a.ND.from("user_api_keys").select("id").eq("user_id",n.id).eq("provider",e).eq("is_active",!0).maybeSingle();if(s){let{data:e,error:n}=await a.ND.from("user_api_keys").update({api_key:o.trim(),is_global:r,updated_at:new Date().toISOString()}).eq("id",s.id).select().maybeSingle();if(n)throw n;if(!e)throw Error("Erro ao atualizar API Key");t=e}else{await a.ND.from("user_api_keys").update({is_active:!1}).eq("user_id",n.id).eq("provider",e);let{data:s,error:i}=await a.ND.from("user_api_keys").insert({user_id:n.id,provider:e,api_key:o.trim(),is_global:r,is_active:!0}).select().maybeSingle();if(i)throw i;if(!s)throw Error("Erro ao criar API Key");t=s}return t}catch(e){throw console.error("Erro ao salvar API Key:",e),Error(e.message||"Erro ao salvar API Key")}}async function s(){try{let{data:{user:e}}=await a.ND.auth.getUser();if(!e)return[];let{data:o,error:r}=await a.ND.from("user_api_keys").select("*").eq("user_id",e.id).order("created_at",{ascending:!1});if(r)throw r;return o||[]}catch(e){return console.error("Erro ao listar API Keys:",e),[]}}async function i(e){try{let{data:{user:o}}=await a.ND.auth.getUser();if(!o)throw Error("Usu\xe1rio n\xe3o autenticado");let{error:r}=await a.ND.from("user_api_keys").delete().eq("id",e).eq("user_id",o.id);if(r)throw r}catch(e){throw console.error("Erro ao deletar API Key:",e),Error(e.message||"Erro ao deletar API Key")}}async function c(e,o){try{let{data:{user:r}}=await a.ND.auth.getUser();if(!r)return;let{data:t}=await a.ND.from("user_api_keys").select("usage_count, total_tokens_used").eq("user_id",r.id).eq("provider",e).eq("is_active",!0).maybeSingle();if(!t)return;let{error:n}=await a.ND.from("user_api_keys").update({usage_count:(t.usage_count||0)+1,total_tokens_used:(t.total_tokens_used||0)+o,last_used_at:new Date().toISOString()}).eq("user_id",r.id).eq("provider",e).eq("is_active",!0);n&&console.error("Erro ao atualizar estat\xedsticas:",n)}catch(e){console.error("Erro ao atualizar uso da API Key:",e)}}async function l(e){try{if(!e||0===e.trim().length)return!1;e.startsWith("AIzaSy")||console.warn("API Key do Gemini n\xe3o tem o formato esperado (deve come\xe7ar com AIzaSy)");let o=await fetch("https://generativelanguage.googleapis.com/v1beta/models?key=".concat(encodeURIComponent(e.trim())),{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok){let e=await o.text();return console.error("Erro na valida\xe7\xe3o Gemini:",o.status,e),!1}let r=await o.json();return r&&Array.isArray(r.models)&&r.models.length>0}catch(e){var o,r;if(console.error("Erro ao validar API Key do Gemini:",e),(null==(o=e.message)?void 0:o.includes("Failed to fetch"))||(null==(r=e.message)?void 0:r.includes("NetworkError")))return console.warn("Erro de rede ao validar. Permitindo salvar a chave para tentativa posterior."),!0;return!1}}async function d(e){try{if(!e||0===e.trim().length)return!1;e.startsWith("sk-")||console.warn("API Key da OpenAI n\xe3o tem o formato esperado (deve come\xe7ar com sk-)");let o=await fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:"Bearer ".concat(e.trim()),"Content-Type":"application/json"}});if(!o.ok){let e=await o.text();return console.error("Erro na valida\xe7\xe3o OpenAI:",o.status,e),o.status,!1}let r=await o.json();return r&&Array.isArray(r.data)&&r.data.length>0}catch(e){var o,r;if(console.error("Erro ao validar API Key da OpenAI:",e),(null==(o=e.message)?void 0:o.includes("Failed to fetch"))||(null==(r=e.message)?void 0:r.includes("NetworkError")))return console.warn("Erro de rede ao validar. Permitindo salvar a chave para tentativa posterior."),!0;return!1}}},5024:(e,o,r)=>{r.d(o,{It:()=>p,Ty:()=>d,du:()=>g,ex:()=>m,gg:()=>n,nG:()=>v,oo:()=>u,vQ:()=>l,x8:()=>s,zN:()=>c});var a=r(3217);async function t(){try{let{data:{session:e}}=await a.ND.auth.getSession();if(!(null==e?void 0:e.user))return null;let{data:o,error:r}=await a.ND.from("subscriptions").select("\n        *,\n        plan:plans(*)\n      ").eq("user_id",e.user.id).eq("is_active",!0).order("created_at",{ascending:!1}).limit(1).single();if(r){if("PGRST116"===r.code)return console.warn("⚠️ [getCurrentSubscription] Nenhuma assinatura encontrada para o usu\xe1rio. Verifique se o trigger est\xe1 criando subscriptions automaticamente."),null;throw console.error("❌ [getCurrentSubscription] Erro ao buscar subscription:",r),r}return o}catch(e){return console.error("❌ [getCurrentSubscription] Erro ao buscar subscription:",e),null}}async function n(){try{var e;let o=await t();if(!o)return{allowed:!1,reason:"Nenhuma assinatura ativa encontrada. Por favor, entre em contato com o suporte."};if(!(null==(e=o.plan)?void 0:e.can_share_chat))return{allowed:!1,reason:"Compartilhamento de chat n\xe3o dispon\xedvel no plano Trial. Fa\xe7a upgrade para acessar este recurso."};return{allowed:!0}}catch(e){return console.error("❌ Erro ao verificar compartilhamento:",e),{allowed:!1,reason:"Erro ao verificar permiss\xe3o. Tente novamente."}}}async function s(e){try{let{data:{session:o}}=await a.ND.auth.getSession();if(!(null==o?void 0:o.user))return!1;let{data:r,error:t}=await a.ND.rpc("check_user_access",{p_user_id:o.user.id,p_feature:e});if(t)return console.error("❌ Erro ao verificar acesso:",t),!1;return!0===r}catch(e){return console.error("❌ Erro ao verificar acesso:",e),!1}}async function i(e,o,r,t,n){try{let{data:{session:s}}=await a.ND.auth.getSession();if(!(null==s?void 0:s.user))return console.error("❌ Usu\xe1rio n\xe3o autenticado para registrar uso"),!1;let{error:i}=await a.ND.rpc("track_token_usage",{p_user_id:s.user.id,p_tokens_used:e,p_usage_type:o,p_model_used:r,p_prompt_id:t||null,p_version_id:n||null});if(i)return console.error("❌ Erro ao registrar uso de tokens:",i),!1;return!0}catch(e){return console.error("❌ Erro ao registrar uso de tokens:",e),!1}}async function c(){try{var e,o,r;let n=await t();if(!n)return{tokensUsed:0,tokensLimit:1e6,percentage:0};let{data:{session:s}}=await a.ND.auth.getSession();if(!(null==s?void 0:s.user))return{tokensUsed:0,tokensLimit:(null==(o=n.plan)?void 0:o.max_tokens_per_month)||1e6,percentage:0};let i=new Date,c=i.getFullYear(),l=i.getMonth()+1,{data:d,error:u}=await a.ND.from("usage_tracking").select("tokens_used").eq("user_id",s.user.id).eq("usage_year",c).eq("usage_month",l);if(u)return console.error("❌ Erro ao buscar uso:",u),{tokensUsed:0,tokensLimit:(null==(r=n.plan)?void 0:r.max_tokens_per_month)||1e6,percentage:0};let m=(null==d?void 0:d.reduce((e,o)=>e+(o.tokens_used||0),0))||0,p=(null==(e=n.plan)?void 0:e.max_tokens_per_month)||1e6,v=p>0?Math.round(m/p*100):0;return{tokensUsed:m,tokensLimit:p,percentage:v}}catch(e){return console.error("❌ Erro ao buscar uso do m\xeas:",e),{tokensUsed:0,tokensLimit:1e6,percentage:0}}}async function l(){try{var e,o,r,n;let s=await t();if(!s)return{versionsCount:0,versionsLimit:4,canCreateMore:!0};let{data:{session:i}}=await a.ND.auth.getSession();if(!(null==i?void 0:i.user))return{versionsCount:0,versionsLimit:(null==(o=s.plan)?void 0:o.max_prompt_versions)||4,canCreateMore:!0};let c=new Date,l=new Date(c.getFullYear(),c.getMonth(),1),{data:d,error:u}=await a.ND.from("prompts").select("id").eq("user_id",i.user.id);if(u||!(null==d?void 0:d.length))return{versionsCount:0,versionsLimit:(null==(r=s.plan)?void 0:r.max_prompt_versions)||4,canCreateMore:!0};let m=d.map(e=>e.id),{data:p,error:v}=await a.ND.from("prompt_versions").select("id").in("prompt_id",m).gte("created_at",l.toISOString());if(v)return console.error("❌ Erro ao contar vers\xf5es:",v),{versionsCount:0,versionsLimit:(null==(n=s.plan)?void 0:n.max_prompt_versions)||4,canCreateMore:!0};let g=(null==p?void 0:p.length)||0,E=(null==(e=s.plan)?void 0:e.max_prompt_versions)||4;return{versionsCount:g,versionsLimit:E,canCreateMore:-1===E||g<E}}catch(e){return console.error("❌ Erro ao contar vers\xf5es:",e),{versionsCount:0,versionsLimit:4,canCreateMore:!0}}}async function d(){let e=await t();if(!e||!e.plan)return console.warn("⚠️ [getCurrentPlanInfo] Nenhuma subscription ou plano encontrado."),null;let o="trial"===e.status,r=null;if(o&&e.trial_ends_at){let o=new Date(e.trial_ends_at),a=new Date;r=Math.max(0,Math.ceil((o.getTime()-a.getTime())/864e5))}return{planName:e.plan.name,displayName:e.plan.display_name,isTrial:o,trialDaysLeft:r,canShareChat:e.plan.can_share_chat,maxVersions:e.plan.max_prompt_versions,maxTokens:e.plan.max_tokens_per_month}}async function u(e){try{var o;let r=await t();if(!r)return{allowed:!1,reason:"Nenhuma assinatura ativa encontrada. Por favor, entre em contato com o suporte."};if((null==(o=r.plan)?void 0:o.max_tokens_per_month)===-1)return{allowed:!0};let a=await c();if(-1===a.tokensLimit)return{allowed:!0};if(a.tokensUsed+e>a.tokensLimit){let e=Math.max(0,a.tokensLimit-a.tokensUsed);return{allowed:!1,reason:"Limite de tokens excedido. Voc\xea tem ".concat(e.toLocaleString("pt-BR")," tokens restantes este m\xeas. Upgrade seu plano para continuar.")}}return{allowed:!0}}catch(e){return console.error("❌ Erro ao verificar tokens:",e),{allowed:!1,reason:"Erro ao verificar limite de tokens. Tente novamente."}}}async function m(e){let o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"prompt_generation",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"gemini-2.5-flash",a=arguments.length>3?arguments[3]:void 0,t=arguments.length>4?arguments[4]:void 0;return i(e,o,r,a,t)}async function p(){let[e,o,r]=await Promise.all([d(),l(),c()]);return{canCreateVersion:o.canCreateMore,canShareChat:(null==e?void 0:e.canShareChat)||!1,versionsCount:o.versionsCount,versionsLimit:o.versionsLimit,tokensUsed:r.tokensUsed,tokensLimit:r.tokensLimit,trialDaysLeft:(null==e?void 0:e.trialDaysLeft)||null}}async function v(){if(!await s("create_version")){let e=await l();return{allowed:!1,reason:"Limite de vers\xf5es atingido! Voc\xea j\xe1 criou ".concat(e.versionsCount," de ").concat(e.versionsLimit," vers\xf5es permitidas no seu plano este m\xeas. Upgrade para Premium para criar vers\xf5es ilimitadas.")}}return{allowed:!0}}async function g(){}},6517:(e,o,r)=>{r.d(o,{IG:()=>A,KR:()=>g,BE:()=>u,CB:()=>h,DF:()=>E,K8:()=>f,Rc:()=>O,Z4:()=>v});var a=r(2014),t=r(5024);function n(e){return e&&"string"==typeof e?Math.ceil(e.length/4):0}function s(e,o){return n(e)+n(o)}var i=r(906),c=r(5704);let l=async()=>{let e=await (0,i.dD)("gemini"),o=!1;if(e)o=!0;else{var r,t;if(!(e=void 0!==c&&(null==(r=c.env)?void 0:r.GEMINI_API_KEY)||void 0!==c&&(null==(t=c.env)?void 0:t.API_KEY)||""))throw Error("API_KEY n\xe3o configurada. Configure sua pr\xf3pria API Key nas Configura\xe7\xf5es ou configure a GEMINI_API_KEY do sistema.")}return{ai:new a.M4({apiKey:e}),usingUserKey:o,apiKey:e}},d="gemini-2.5-flash",u=async e=>{if(!e.persona||!e.persona.trim())throw Error('Campo "Persona" \xe9 obrigat\xf3rio');if(!e.objetivo||!e.objetivo.trim())throw Error('Campo "Objetivo" \xe9 obrigat\xf3rio');if(!e.contextoNegocio||!e.contextoNegocio.trim())throw Error('Campo "Contexto do Neg\xf3cio" \xe9 obrigat\xf3rio');if(!e.contexto||!e.contexto.trim())throw Error('Campo "Contexto da Intera\xe7\xe3o" \xe9 obrigat\xf3rio');let{ai:o,usingUserKey:r}=await l(),a="\n# INFORMA\xc7\xd5ES BASE PARA GERA\xc7\xc3O DO PROMPT MESTRE\n\n## IDENTIDADE CENTRAL & EXPERTISE (PERSONA)\n".concat(e.persona.trim(),"\n\n## OBJETIVO PRINCIPAL\n").concat(e.objetivo.trim(),"\n\n## CONTEXTO DO NEG\xd3CIO\n").concat(e.contextoNegocio.trim(),"\n\n## CONTEXTO DA INTERA\xc7\xc3O\n").concat(e.contexto.trim(),"\n");e.ferramentas.length>0&&(a+="\n## FERRAMENTAS DISPON\xcdVEIS (TOOLS)\n",e.ferramentas.forEach(e=>{a+="- **".concat(e.nome,"**: ").concat(e.descricao,"\n")})),e.variaveisDinamicas.length>0&&(a+="\n## VARI\xc1VEIS DIN\xc2MICAS\n",e.variaveisDinamicas.forEach(e=>{a+="- **{{".concat(e.chave,"}}**: (Valor de exemplo: ").concat(e.valor,")\n")})),a+="\n## REGRAS CR\xcdTICAS INVIOL\xc1VEIS\n".concat(e.regras.map(e=>"- ".concat(e)).join("\n"),"\n"),e.exemplos.length>0&&(a+="\n## EXEMPLOS (FEW-SHOT LEARNING)\n",e.exemplos.forEach(e=>{a+="### Exemplo:\n- **Usu\xe1rio:** ".concat(e.user,"\n- **Agente:** ").concat(e.agent,"\n")})),e.fluxos&&e.fluxos.length>0&&(a+="\n## FLUXOS DE INTERA\xc7\xc3O ESPEC\xcdFICOS\n",e.fluxos.forEach(e=>{a+="### Fluxo: ".concat(e.nome," (").concat(e.tipoPrompt,")\n- Objetivo: ").concat(e.objetivo,"\n"),e.baseConhecimentoRAG&&(a+="- Contexto/RAG: ".concat(e.baseConhecimentoRAG,"\n")),e.reforcarCoT&&(a+="- [REFOR\xc7AR CHAIN-OF-THOUGHT NESTE FLUXO]\n"),e.ativarGuardrails&&(a+="- [ATIVAR GUARDRAILS ESTRITOS NESTE FLUXO]\n"),e.fewShotExamples&&(a+="- Exemplos do fluxo:\n".concat(e.fewShotExamples,"\n"))})),a+="\n## FORMATO E ESTRUTURA DE RESPOSTA DO AGENTE\n- **Formato Alvo do Agente:** ".concat(e.formatoSaida.toUpperCase(),"\n- **Estrutura Esperada:** ").concat(e.estruturaSaida,"\n"),["json","xml","yaml"].includes(e.formatoSaida)?a+="\n### RESTRI\xc7\xd5ES ESTRITAS DE FORMATO DO AGENTE (".concat(e.formatoSaida.toUpperCase(),")\nPara garantir a integridade t\xe9cnica da resposta, as seguintes restri\xe7\xf5es S\xc3O OBRIGAT\xd3RIAS para o Agente Final:\n1. **SEM MARKDOWN NA RESPOSTA FINAL:** A resposta do agente N\xc3O DEVE conter blocos de c\xf3digo Markdown. Deve ser apenas o dado puro.\n2. **SEM TEXTO CONVERSACIONAL:** A resposta deve come\xe7ar imediatamente com o primeiro caractere v\xe1lido do formato.\n"):"text"===e.formatoSaida&&(a+="\n### RESTRI\xc7\xd5ES DE FORMATO DO AGENTE (TEXTO PURO)\n1. **LINGUAGEM NATURAL:** A resposta deve ser em texto corrido natural, focado no usu\xe1rio final.\n2. **SEM FORMATA\xc7\xc3O COMPLEXA:** Evite uso excessivo de Markdown. NUNCA use blocos de c\xf3digo para texto normal.\n");let n='\nVoc\xea \xe9 um especialista s\xeanior em engenharia de prompts. Sua tarefa \xe9 pegar as informa\xe7\xf5es base fornecidas e expandi-las em um "PROMPT MESTRE" detalhado e robusto.\n\n**INFORMA\xc7\xd5ES BASE:**\n---\n'.concat(a.trim(),"\n---\n\n**REQUISITOS DO PROMPT MESTRE:**\n1. **EXPANS\xc3O INTELIGENTE:** Use as informa\xe7\xf5es base como n\xfacleo. Expanda se\xe7\xf5es, adicione detalhes, explica\xe7\xf5es e exemplos consistentes com a persona.\n2. **TAMANHO ALVO:** Aproximadamente **").concat(e.promptSize,"** caracteres.\n3. **FORMATO DE SA\xcdDA DO PROMPT MESTRE:** O prompt mestre que VOC\xca vai gerar deve estar no formato **").concat(e.masterPromptFormat.toUpperCase(),"**.\n");"markdown"===e.masterPromptFormat?n+="\n**ESTRUTURA MARKDOWN ESPERADA (CR\xcdTICO - DEVE SER MARKDOWN 100% COM HIERARQUIA):**\n\nO prompt mestre DEVE seguir uma hierarquia Markdown completa e bem estruturada:\n\n1. **T\xcdTULOS COM HIERARQUIA:**\n   - Use # (H1) apenas para o t\xedtulo principal do prompt\n   - Use ## (H2) para se\xe7\xf5es principais (PERSONA, OBJETIVO, CONTEXTO, REGRAS, etc.)\n   - Use ### (H3) para subse\xe7\xf5es dentro de cada se\xe7\xe3o principal\n   - Use #### (H4) para sub-subse\xe7\xf5es quando necess\xe1rio\n   - Use ##### (H5) para detalhamentos finos quando necess\xe1rio\n\n2. **FORMATA\xc7\xc3O:**\n   - Use **negrito** para destacar conceitos importantes\n   - Use *it\xe1lico* para \xeanfase\n   - Use c\xf3digo inline (backtick) para nomes de vari\xe1veis, fun\xe7\xf5es ou termos t\xe9cnicos\n   - Use listas ordenadas (1., 2., 3.) para instru\xe7\xf5es sequenciais\n   - Use listas n\xe3o ordenadas (- ou *) para itens relacionados\n   - Use > para cita\xe7\xf5es ou blocos de destaque quando apropriado\n   - Use blocos de c\xf3digo (tr\xeas backticks) quando necess\xe1rio\n\n3. **ESTRUTURA ESPERADA:**\n   - T\xedtulo principal com #\n   - Se\xe7\xf5es principais com ##\n   - Subse\xe7\xf5es com ###\n   - Conte\xfado formatado com listas, negrito, it\xe1lico e c\xf3digo inline\n   - Organiza\xe7\xe3o hier\xe1rquica clara para facilitar leitura por LLMs\n\n4. **EXEMPLO DE ESTRUTURA:**\n(BLOCO DE C\xd3DIGO MARKDOWN)\n# T\xcdTULO PRINCIPAL DO PROMPT\n\n## PERSONA\n\n### Identidade Central\n[conte\xfado detalhado]\n\n### Especializa\xe7\xe3o\n[conte\xfado detalhado]\n\n## OBJETIVO\n\n### Objetivo Principal\n[conte\xfado detalhado]\n\n## REGRAS\n\n### Regras Cr\xedticas\n- Regra 1: [descri\xe7\xe3o]\n- Regra 2: [descri\xe7\xe3o]\n(FIM DO BLOCO)\n\nSua resposta deve ser APENAS o texto Markdown do prompt final, SEM explica\xe7\xf5es ou coment\xe1rios adicionais.\n":"json"===e.masterPromptFormat&&(n+='\n**ESTRUTURA JSON ESPERADA (CR\xcdTICO - DEVE SER JSON 100% ESTRUTURADO):**\n\nO prompt mestre DEVE ser um objeto JSON v\xe1lido, bem formatado e estruturado:\n\n1. **FORMATA\xc7\xc3O OBRIGAT\xd3RIA:**\n   - Use indenta\xe7\xe3o de 2 espa\xe7os para cada n\xedvel\n   - Use quebras de linha ap\xf3s cada chave/valor\n   - Use v\xedrgulas apropriadas (n\xe3o v\xedrgula final)\n   - Use aspas duplas para todas as strings\n   - Use arrays para listas de itens\n   - Use objetos aninhados para estruturas hier\xe1rquicas\n\n2. **ESTRUTURA SUGERIDA:**\n   {\n     "persona": {\n       "identity": "...",\n       "expertise": "...",\n       "tone": "..."\n     },\n     "objective": {\n       "primary": "...",\n       "secondary": ["...", "..."]\n     },\n     "context": {\n       "business": "...",\n       "interaction": "..."\n     },\n     "rules": [\n       "Regra 1: ...",\n       "Regra 2: ..."\n     ],\n     "instructions": {\n       "format": "...",\n       "style": "...",\n       "examples": ["...", "..."]\n     }\n   }\n\n3. **REQUISITOS CR\xcdTICOS:**\n   - O JSON DEVE ser v\xe1lido e bem formatado (passar em JSON.parse())\n   - Use indenta\xe7\xe3o consistente (2 espa\xe7os por n\xedvel)\n   - Strings podem conter quebras de linha \\n quando necess\xe1rio\n   - Strings podem conter markdown DENTRO delas se apropriado\n   - Estruture de forma hier\xe1rquica para facilitar leitura por LLMs\n\n4. **N\xc3O FA\xc7A:**\n   - N\xe3o retorne JSON em um bloco de c\xf3digo markdown (tr\xeas backticks json)\n   - N\xe3o adicione explica\xe7\xf5es antes ou depois do JSON\n   - N\xe3o use formata\xe7\xe3o compacta (tudo em uma linha)\n   - N\xe3o use aspas simples para strings\n\nSua resposta deve ser APENAS o objeto JSON v\xe1lido, SEM blocos de c\xf3digo markdown, SEM explica\xe7\xf5es, APENAS o JSON puro e bem formatado.\n');let c=s(n,""),d=await (0,t.oo)(c);if(!d.allowed)throw Error(d.reason||"Limite de tokens excedido");let u=await o.models.generateContent({model:"gemini-2.5-pro",contents:n,config:"json"===e.masterPromptFormat?{responseMimeType:"application/json"}:void 0});if(!u.text)throw Error("Resposta vazia do modelo Gemini");let m=s(n,u.text);await (0,t.ex)(m),r&&await (0,i.cI)("gemini",m);let p=u.text.trim();if("json"===e.masterPromptFormat)try{p=(p=p.replace(/^```json\s*/i,"").replace(/\s*```$/i,"").trim()).replace(/^```\s*/i,"").replace(/\s*```$/i,"").trim();let e=JSON.parse(p);p=JSON.stringify(e,null,2)}catch(o){console.warn("⚠️ Erro ao formatar JSON, retornando texto original:",o);let e=p.match(/\{[\s\S]*\}/);if(e)try{let o=JSON.parse(e[0]);p=JSON.stringify(o,null,2)}catch(e){console.error("❌ Erro ao extrair JSON:",e)}}return p},m=null,p=null,v=async e=>{let{ai:o,usingUserKey:r,apiKey:a}=await l();p={usingUserKey:r,apiKey:a};try{JSON.parse(e)}catch(e){}m=o.chats.create({model:d,config:{systemInstruction:e}})},g=async(e,o)=>{if(!m)throw Error("Chat n\xe3o iniciado. Selecione uma vers\xe3o de prompt para come\xe7ar.");try{let r=s(e+(o||""),""),a=await (0,t.oo)(r);if(!a.allowed)throw Error(a.reason||"Limite de tokens excedido");let n=await m.sendMessage({message:e});if(!n.text)throw Error("Resposta vazia do modelo Gemini");let c=s(e,n.text);return await (0,t.ex)(c),(null==p?void 0:p.usingUserKey)&&await (0,i.cI)("gemini",c),n.text}catch(e){if(console.error("Error in chat:",e),e.message&&e.message.includes("Limite de tokens"))throw e;throw Error(e.message||"Falha ao se comunicar com a API da Gemini no chat.")}},E=async e=>{let{ai:o,usingUserKey:r,apiKey:t}=await l();try{let r="\n        **Persona do Agente:** ".concat(e.persona,"\n        **Objetivo Principal:** ").concat(e.objetivo,"\n        **Contexto do Neg\xf3cio:** ").concat(e.contextoNegocio,"\n        **Contexto da Intera\xe7\xe3o:** ").concat(e.contexto,"\n        **Regras:** ").concat(e.regras.join(", "),"\n        **Formato de Sa\xedda do Agente:** ").concat(e.formatoSaida.toUpperCase(),"\n        "),t="\n        Com base no contexto, gere 2-3 exemplos de intera\xe7\xf5es (usu\xe1rio/agente).\n        ";["json","xml","yaml"].includes(e.formatoSaida)&&(t+=" IMPORTANTE: A resposta do 'agent' nos exemplos deve ser EXATAMENTE no formato ".concat(e.formatoSaida.toUpperCase()," solicitado.")),t+="\n        **Contexto:**\n        ---\n        ".concat(r,"\n        ---\n        Retorne os exemplos como um array JSON.\n        ");let n=await o.models.generateContent({model:d,contents:t,config:{responseMimeType:"application/json",responseSchema:{type:a.ZU.ARRAY,items:{type:a.ZU.OBJECT,properties:{user:{type:a.ZU.STRING},agent:{type:a.ZU.STRING}},required:["user","agent"]}}}});if(!n.text)throw Error("Resposta vazia do modelo Gemini ao gerar exemplos");return JSON.parse(n.text.trim())}catch(e){throw console.error("Error generating examples:",e),Error("Falha ao gerar exemplos.")}},f=async function(e,o){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",{ai:a,usingUserKey:t,apiKey:n}=await l();try{let t=o.length>0?o.map((e,o)=>"\n### Corre\xe7\xe3o ".concat(o+1,'\n- **Consulta:** "').concat(e.userQuery,'"\n- **Resposta Antiga (Ruim):** "').concat(e.originalResponse,'"\n- **Resposta Nova (Ideal):** "').concat(e.correctedResponse,'"\n')).join("\n"):"Nenhuma corre\xe7\xe3o espec\xedfica de chat.",n="\nVoc\xea \xe9 um especialista em engenharia de prompts. Refatore o prompt abaixo com base no feedback.\nMANTENHA O MESMO FORMATO (Markdown ou JSON) do prompt original.\n\n**PROMPT ATUAL:**\n---\n".concat(e,"\n---\n\n**FEEDBACK (CORRE\xc7\xd5ES):**\n---\n").concat(t,"\n---\n\n**INSTRU\xc7\xd5ES MANUAIS:**\n---\n").concat(r.trim()||"Nenhuma instru\xe7\xe3o adicional.","\n---\n\nReescreva o prompt para corrigir os problemas identificados. Retorne APENAS o novo prompt.\n"),s=!1;try{JSON.parse(e),s=!0}catch(e){}let i=s?"".concat(n,"\n\n**IMPORTANTE - FORMATO JSON:**\n- O prompt otimizado DEVE ser um JSON v\xe1lido e bem formatado\n- Use indenta\xe7\xe3o de 2 espa\xe7os por n\xedvel\n- Use quebras de linha ap\xf3s cada chave/valor\n- N\xc3O retorne JSON em bloco de c\xf3digo markdown (sem tr\xeas backticks json)\n- Retorne APENAS o objeto JSON puro, bem formatado e estruturado\n- Garanta que o JSON seja v\xe1lido e pass\xedvel de parse com JSON.parse()\n"):n,c=await a.models.generateContent({model:"gemini-2.5-pro",contents:i,config:s?{responseMimeType:"application/json"}:void 0});if(!c.text)throw Error("Resposta vazia do modelo Gemini ao otimizar prompt");let l=c.text.trim();if(s)try{l=(l=l.replace(/^```json\s*/i,"").replace(/\s*```$/i,"").trim()).replace(/^```\s*/i,"").replace(/\s*```$/i,"").trim();let e=JSON.parse(l);l=JSON.stringify(e,null,2)}catch(o){console.warn("⚠️ Erro ao formatar JSON otimizado, tentando extrair JSON:",o);let e=l.match(/\{[\s\S]*\}/);if(e)try{let o=JSON.parse(e[0]);l=JSON.stringify(o,null,2)}catch(e){console.error("❌ Erro ao extrair e formatar JSON:",e)}}return l}catch(e){throw console.error("Error optimizing prompt:",e),Error((null==e?void 0:e.message)||(null==e?void 0:e.toString())||"Falha na otimiza\xe7\xe3o.")}},h=async e=>{let{ai:o,usingUserKey:r,apiKey:a}=await l();try{let r=await o.models.generateContent({model:"gemini-2.5-pro",contents:"\nVoc\xea \xe9 um especialista em engenharia de prompts e comunica\xe7\xe3o t\xe9cnica. Sua tarefa \xe9 analisar o prompt de IA fornecido e gerar uma documenta\xe7\xe3o clara, detalhada e pedag\xf3gica sobre ele. O p\xfablico-alvo desta documenta\xe7\xe3o s\xe3o clientes e membros n\xe3o-t\xe9cnicos da equipe do projeto.\n\nA documenta\xe7\xe3o deve explicar:\n1. **Objetivo Geral:** Qual \xe9 a principal fun\xe7\xe3o do agente de IA que usar\xe1 este prompt?\n2. **Persona e Tom de Voz:** Como o agente se comportar\xe1? Qual \xe9 sua personalidade?\n3. **Principais Regras e Limita\xe7\xf5es:** Quais s\xe3o as diretrizes mais importantes que o agente deve seguir?\n4. **Entradas e Sa\xeddas:** Que tipo de informa\xe7\xe3o o agente espera e como ele deve formatar suas respostas?\n5. **Exemplos Pr\xe1ticos:** Se houver exemplos, explique o que eles demonstram.\n6. **Fluxo de Conversa:** Descreva um exemplo de como uma conversa com este agente poderia acontecer.\n\nUse formata\xe7\xe3o Markdown (t\xedtulos, listas, negrito) para tornar o documento f\xe1cil de ler e bem estruturado. A linguagem deve ser simples e evitar jarg\xf5es t\xe9cnicos sempre que poss\xedvel.\n\n**PROMPT PARA ANALISAR:**\n---\n".concat(e,"\n---\n\nRetorne APENAS a documenta\xe7\xe3o em Markdown.")});if(!r.text)throw Error("Resposta vazia do modelo Gemini ao explicar prompt");return r.text}catch(e){throw console.error("Error explaining prompt:",e),Error("Falha ao gerar a explica\xe7\xe3o do prompt.")}},S=async function(e){let o,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let c=0;c<=r;c++)try{return await e()}catch(l){var t,n,s,i;if(o=l,!((null==l?void 0:l.status)===503||(null==l?void 0:l.status)===429||(null==l?void 0:l.status)===500||(null==l?void 0:l.status)===502||(null==l?void 0:l.code)===503||(null==l?void 0:l.code)===429||(null==l?void 0:l.code)===500||(null==l?void 0:l.code)===502||(null==l||null==(t=l.message)?void 0:t.includes("overloaded"))||(null==l||null==(n=l.message)?void 0:n.includes("try again later"))||(null==l||null==(s=l.message)?void 0:s.includes("rate limit"))||(null==l||null==(i=l.message)?void 0:i.includes("UNAVAILABLE")))||c===r)throw l;let e=a*Math.pow(2,c);await new Promise(o=>setTimeout(o,e))}throw o},A=async(e,o,r)=>{let{ai:n,usingUserKey:c,apiKey:d}=await l(),u="text/csv"===o||(null==r?void 0:r.toLowerCase().endsWith(".csv")),m={inlineData:{data:e,mimeType:o}},p=u?"\nAnalise este arquivo CSV e extraia informa\xe7\xf5es relevantes para criar um prompt de IA.\nIdentifique padr\xf5es, estruturas de dados, contexto de neg\xf3cio e regras de processamento.\n\nPara arquivos CSV, foque em:\n- Entender a estrutura e prop\xf3sito dos dados\n- Identificar campos importantes e suas rela\xe7\xf5es\n- Extrair contexto de neg\xf3cio dos cabe\xe7alhos e dados\n- Identificar regras de valida\xe7\xe3o ou processamento impl\xedcitas\n\nCampos JSON esperados: persona, objetivo, contextoNegocio, contexto, regras (array de strings).\nRetorne sempre um JSON v\xe1lido, mesmo que alguns campos estejam vazios.\n":"\nAnalise o documento e extraia informa\xe7\xf5es para um prompt de IA.\n".concat(r?"Nome do arquivo: ".concat(r,"\n"):"","\nCampos JSON esperados: persona, objetivo, contextoNegocio, contexto, regras (array de strings).\nRetorne sempre um JSON v\xe1lido, mesmo que alguns campos estejam vazios.\n");try{let e=await S(async()=>{let e=u?{type:a.ZU.OBJECT,properties:{persona:{type:a.ZU.STRING},objetivo:{type:a.ZU.STRING},contextoNegocio:{type:a.ZU.STRING},contexto:{type:a.ZU.STRING},regras:{type:a.ZU.ARRAY,items:{type:a.ZU.STRING}}},required:[]}:{type:a.ZU.OBJECT,properties:{persona:{type:a.ZU.STRING},objetivo:{type:a.ZU.STRING},contextoNegocio:{type:a.ZU.STRING},contexto:{type:a.ZU.STRING},regras:{type:a.ZU.ARRAY,items:{type:a.ZU.STRING}}},required:["persona","objetivo","contextoNegocio","contexto","regras"]},o=s(p,""),r=await (0,t.oo)(o);if(!r.allowed)throw Error(r.reason||"Limite de tokens excedido");let l=await n.models.generateContent({model:"gemini-2.5-pro",contents:{parts:[m,{text:p}]},config:{responseMimeType:"application/json",responseSchema:e}});if(!l.text)throw Error("Resposta vazia do modelo Gemini ao extrair dados");let d=s(p,l.text);return await (0,t.ex)(d),c&&await (0,i.cI)("gemini",d),l},3,500);if(!e||!e.text)throw console.error("Resposta vazia ou inv\xe1lida da API:",e),Error("A API retornou uma resposta vazia. Tente novamente.");let o=e.text.trim();if(!o||"undefined"===o||"null"===o)throw console.error("Texto da resposta est\xe1 vazio ou inv\xe1lido:",o),Error("A API retornou dados inv\xe1lidos. Tente novamente.");try{let e=JSON.parse(o);return{persona:e.persona||"",objetivo:e.objetivo||"",contextoNegocio:e.contextoNegocio||"",contexto:e.contexto||"",regras:Array.isArray(e.regras)?e.regras:[]}}catch(e){console.error("Erro ao fazer parse do JSON:",e),console.error("Texto recebido:",o.substring(0,500));try{let e=o.match(/\{[\s\S]*\}/);if(e){let o=JSON.parse(e[0]);return{persona:o.persona||"",objetivo:o.objetivo||"",contextoNegocio:o.contextoNegocio||"",contexto:o.contexto||"",regras:Array.isArray(o.regras)?o.regras:[]}}}catch(e){console.error("Segunda tentativa de parse tamb\xe9m falhou:",e)}throw Error("Erro ao processar a resposta da API".concat(r?" para ".concat(r):"",". O formato retornado \xe9 inv\xe1lido. Tente novamente."))}}catch(e){var v,g,E,f,h,A;if(console.error("Error analyzing document:",e),(null==e?void 0:e.message)&&!(null==e?void 0:e.status)&&!(null==e?void 0:e.code))throw e;if((null==e?void 0:e.status)===503||(null==e?void 0:e.code)===503||(null==e||null==(v=e.message)?void 0:v.includes("overloaded"))||(null==e||null==(g=e.message)?void 0:g.includes("UNAVAILABLE")))throw Error("O servi\xe7o est\xe1 temporariamente sobrecarregado. Por favor, tente novamente em alguns instantes.");if((null==e?void 0:e.status)===429||(null==e?void 0:e.code)===429||(null==e||null==(E=e.message)?void 0:E.includes("rate limit")))throw Error("Muitas requisi\xe7\xf5es. Por favor, aguarde alguns segundos antes de tentar novamente.");if((null==e?void 0:e.status)===400||(null==e?void 0:e.code)===400||(null==e||null==(f=e.message)?void 0:f.includes("400")))throw Error("Formato de arquivo n\xe3o suportado ou inv\xe1lido. Tente converter para PDF ou TXT.");else if((null==e?void 0:e.status)===401||(null==e?void 0:e.code)===401)throw Error("Erro de autentica\xe7\xe3o. Verifique sua chave de API do Gemini.");else if((null==e?void 0:e.status)===413||(null==e?void 0:e.code)===413)throw Error("Arquivo muito grande. Tente um arquivo menor ou divida o documento.");else if((null==e||null==(h=e.message)?void 0:h.includes("JSON"))||(null==e||null==(A=e.message)?void 0:A.includes("parse")))throw Error("Erro ao processar a resposta da API. Tente novamente.");else throw Error((null==e?void 0:e.message)||"Falha ao analisar o documento. Tente novamente mais tarde.")}},N=[{name:"updatePersona",parameters:{type:a.ZU.OBJECT,properties:{text:{type:a.ZU.STRING}},required:["text"]}},{name:"updateObjetivo",parameters:{type:a.ZU.OBJECT,properties:{text:{type:a.ZU.STRING}},required:["text"]}},{name:"updateContextoNegocio",parameters:{type:a.ZU.OBJECT,properties:{text:{type:a.ZU.STRING}},required:["text"]}},{name:"updateContextoInteracao",parameters:{type:a.ZU.OBJECT,properties:{text:{type:a.ZU.STRING}},required:["text"]}},{name:"addRegra",parameters:{type:a.ZU.OBJECT,properties:{text:{type:a.ZU.STRING}},required:["text"]}},{name:"addExemplo",parameters:{type:a.ZU.OBJECT,properties:{user:{type:a.ZU.STRING},agent:{type:a.ZU.STRING}},required:["user","agent"]}}],O=async(e,o)=>{let{ai:r,usingUserKey:a,apiKey:t}=await l();try{return await r.models.generateContent({model:"gemini-2.5-pro",contents:{parts:[{inlineData:{mimeType:o,data:e}},{text:"Processe este comando."}]},config:{systemInstruction:"Voc\xea \xe9 um assistente de preenchimento de formul\xe1rio por voz. Transcreva o \xe1udio do usu\xe1rio e use as ferramentas para atualizar os campos. Responda com [TRANSCRI\xc7\xc3O: ...] seguido de uma confirma\xe7\xe3o curta.",tools:[{functionDeclarations:N}]}})}catch(e){throw console.error("Error processing audio:",e),Error("Falha ao processar \xe1udio.")}}}}]);